<!DOCTYPE html>
<html lang="en" dir="auto">
   <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <title>MacDuck</title>
      <link rel="icon" href="../images/website_icon.svg">
      <meta name="author" content="George Lorentzos">
      <style>
         :root {
         --blue: #4daafc;
         --foreground: #9ba3b4;
         --background: #0D1117;
         --header-foreground: #c3d0e5;
         --codebox: #181f29;
         }
         @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap');
         html, body {
         height: 100%;
         margin: 0;
         background: var(--background);
         color: var(--foreground);
         font-family: 'Montserrat', sans-serif;
         line-height: 1.6;
         -webkit-font-smoothing: antialiased;
         -moz-osx-font-smoothing: grayscale;
         }
         html::-webkit-scrollbar {
         display: none;
         }
         body {
         padding: 0 15px;
         box-sizing: border-box;
         }
         .container {
         max-width: 600px;
         margin: 0 auto;
         border-radius: 8px;
         }
         h1, h2, h3 {
         color: var(--header-foreground);
         font-weight: 600;
         margin-bottom: 0.5em;
         }
         h3 {
         font-size: 1.3em;
         padding-bottom: 0.5em;
         }
         p {
         margin-top: 0.4em;
         margin-bottom: 0.8em;
         }
         a:hover {
         text-decoration: underline;
         }
         pre {
         background: var(--codebox);
         border-radius: 6px;
         padding: 1.2em;
         overflow-x: auto;
         font-size: 0.9rem;
         line-height: 1.4;
         margin: 1.5em 0;
         }
         pre > code {
         background: transparent;
         font-family: 'Fira Code', 'Consolas', monospace;
         }
         html::-webkit-scrollbar{
         display: none;
         }
         pre::-webkit-scrollbar {
         width: 8px;
         height: 8px;
         }
         pre::-webkit-scrollbar-track {
         background: transparent;
         border-radius: 8px;
         }
         pre::-webkit-scrollbar-thumb {
         background-color: var(--blue);
         border-radius: 8px;
         }
         .footer {
         text-align: center;
         margin-top: 40px;
         font-size: 0.9em;
         }
      </style>
   </head>
   <body>
      <div class="container">
         <div style="background: transparent; text-align: center; padding: 30px 20px; border-radius: 8px;">
            <h1>MacDuck</h1>
            <span style="
               display: inline-block;
               padding: 10px 20px;
               border: 1px solid red;
               background-color: #330000;
               color: #ff4d4d; /* light neon red */
               font-weight: bold;
               font-family: 'Arial', sans-serif;
               border-radius: 5px;
               ">
            Under Construction
            </span>
         </div>
         <div style="background-color: var(--codebox); color: var(--blue); padding: 15px; border-radius: 6px; ">
            <strong>Note:</strong> The project is under construction. This is just a first view of how it looks and how it works.
            <br><br>
            The frontend design of this project is not professionally styled, as I am primarily a backend developer. However, I am
            comfortable working with HTML, CSS, and JavaScript.
         </div>
         <h3>Project Details</h3>
         <p>
            I started building it a few days ago and am actively working on it. It's a full e-commerce web application, and this is just an early view of how it looks and functions.
         </p>
        <h3>Core Functionality</h3>
        <strong>User Authentication System</strong> with email verification, password reset, and account management<br><br>
        <strong>Role-Based Access Control</strong> with admin and regular user privileges<br><br>
        <strong>Product Catalog Management</strong> including CRUD operations for products and categories<br><br>
        <strong>Shopping Cart System</strong> with quantity adjustment and real-time updates<br><br>
        <strong>Wishlist Functionality</strong> allowing users to save favorite items<br><br>
        <strong>Checkout Process</strong> with address collection and order summary<br><br>
        <strong>Stripe Payment Integration</strong> for secure credit card processing<br><br>
        <strong>Order Management</strong> with status tracking for both users and admins<br><br>
        <strong>Inventory Management</strong> with stock level tracking<br><br>
        <strong>Product Search</strong> with keyword matching across name and description<br><br>
        <strong>Category Filtering</strong> for easy product discovery<br><br>
        <strong>Email Notifications</strong> for order confirmations, password resets, and account verification<br><br>
        <strong>Responsive UI</strong> designed for both mobile and desktop devices<br><br>
        <strong>Secure Configuration</strong> using environment variables and python-dotenv<br><br>
        <strong>Database Management</strong> with SQLAlchemy for SQLite database operations<br><br>
        <strong>Image Upload</strong> with secure file handling for product media<br><br>
        <strong>Admin Dashboard</strong> with sales analytics and quick access to management functions<br><br>
        <strong>User Account Pages</strong> with order history and profile editing<br><br>
        <strong>Form Validation</strong> for all user inputs with WTForms<br><br>
        <strong>Error Handling</strong> with custom 404 pages and flash messages<br><br>
        <strong>Session Management</strong> for cart persistence and user authentication<br>
         <style>
            .file-links {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            }
            .file-links a {
            text-decoration: none;
            color: var(--blue);
            padding: 10px;
            border-radius: 6px;
            gap: 10px;
            background-color: var(--codebox);
            }
         </style>
         <h3>App Preview <span style="font-weight: normal; font-size: 0.9em;">(images)</span></h3>
         <div class="file-links">
            <a href="../projects/macduck/4.png" target="_blank">shop.png</a>
            <a href="../projects/macduck/1.png" target="_blank">check_user.png</a>
            <a href="../projects/macduck/2.png" target="_blank">login.png</a>
            <a href="../projects/macduck/3.png" target="_blank">email_verify.png</a>
            <a href="../projects/macduck/9.png" target="_blank">product.png</a>
            <a href="../projects/macduck/5.png" target="_blank">cart.png</a>
            <a href="../projects/macduck/6.png" target="_blank">checkout.png</a>
            <a href="../projects/macduck/7.png" target="_blank">pay.png</a>
            <a href="../projects/macduck/8.png" target="_blank">profile.png</a>
         </div>
         <h3>All Code <span style="font-weight: normal; font-size: 0.9em;">(app.py)</span></h3>
         <pre><code class="language-python">"""
MacDuck – Full E-commerce Web App
-------Under Construction-------
Copyright © 2025 George Lorentzos All rights reserved.
Unauthorized copying, reproduction, or distribution is prohibited.
---------------------------------
"""

from flask import (
    Flask,
    request,
    render_template,
    redirect,
    url_for,
    flash,
    get_flashed_messages,
    send_from_directory,
    jsonify,
    session,
)
from flask_sqlalchemy import SQLAlchemy
from dotenv import load_dotenv
import os
from flask_login import (
    UserMixin,
    LoginManager,
    login_user,
    current_user,
    logout_user,
)
from datetime import datetime, timedelta
from flask_wtf import FlaskForm
from wtforms import (
    StringField,
    EmailField,
    IntegerField,
    PasswordField,
    SubmitField,
    HiddenField,
    SelectField,
    FileField,
    TextAreaField,
)
from wtforms.validators import DataRequired, NumberRange
from sqlalchemy import or_
from flask_bcrypt import Bcrypt
from werkzeug.utils import secure_filename
from wtforms import DecimalField
from flask_mail import Mail, Message
import stripe
import json
import random
from urllib.parse import quote
from functools import wraps

load_dotenv()

app = Flask(__name__)
app.config["SECRET_KEY"] = os.getenv("SECRET_KEY")
app.config["SQLALCHEMY_DATABASE_URI"] = "sqlite:///macduck.db"

db = SQLAlchemy(app)
lg = LoginManager(app)
bc = Bcrypt(app)

app.config["MAIL_SERVER"] = "smtp.gmail.com"
app.config["MAIL_PORT"] = 465
app.config["MAIL_USERNAME"] = os.getenv("MAIL_USERNAME")
app.config["MAIL_PASSWORD"] = os.getenv("MAIL_PASSWORD")
app.config["MAIL_DEFAULT_SENDER"] = os.getenv("MAIL_USERNAME")
app.config["MAIL_USE_SSL"] = True
app.config["MAIL_USE_TLS"] = False

mail = Mail(app)

stripe.api_key = os.getenv("STRIPE_SECRET_KEY")
STRIPE_PUBLISHABLE_KEY = os.getenv("STRIPE_PUBLISHABLE_KEY")
STRIPE_WEBHOOK_SECRET = os.getenv("STRIPE_WEBHOOK_SECRET")

upload_folder = os.path.join(os.getcwd(), "static/product-media")
lg.login_view = "login"

random_string = "qwertyuiopasdfghjklzxcvbnm"
random_numbers = "1234567890"
random_symbols = "-."

def login_required(f):
    @wraps(f)
    def check_function(*args, **kwargs):
        if not current_user.is_authenticated:
            flash("Please login to access this page.", "danger")
            return redirect("/auth")
        return f(*args, **kwargs)
    return check_function

def admin_required(f):
    @wraps(f)
    def check_function(*args, **kwargs):
        if not current_user.is_admin:
            return redirect("/")
        return f(*args, **kwargs)
    return check_function

@app.errorhandler(404)
def notfound(error):
    return render_template("404.html"), 404

@lg.user_loader
def user_loader(user_id):
    return User.query.get(int(user_id))

if not os.path.exists(upload_folder):
    os.makedirs(upload_folder)

class User(UserMixin, db.Model):
    id = db.Column(db.Integer, primary_key=True)
    username = db.Column(db.String, unique=True, nullable=False)
    phonenumber = db.Column(db.String, unique=True, nullable=True, default=None)
    email = db.Column(db.String, unique=True, nullable=False)
    password = db.Column(db.String, nullable=True, default=None)
    createdat = db.Column(db.DateTime, default=datetime.utcnow, nullable=False)
    cart = db.relationship("Cart", backref="cart_owner", lazy=True)
    is_admin = db.Column(db.Boolean, default=False, nullable=False)
    is_account_completed = db.Column(db.Boolean, default=False, nullable=False)

    def __repr__(self):
        return self.username

class Product(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    front_image = db.Column(db.String, nullable=True)
    back_image = db.Column(db.String, nullable=True)
    name = db.Column(db.String, nullable=False)
    description = db.Column(db.String, nullable=False)
    price = db.Column(db.Float, nullable=False)
    category_id = db.Column(db.Integer, db.ForeignKey("category.id"), nullable=False)
    category_name = db.Column(db.String, nullable=False)
    category = db.relationship("Category", backref="products")
    quantity = db.Column(db.Integer, default=0, nullable=False)
    is_available = db.Column(db.Boolean, default=True, nullable=False)

    recognition_id = db.Column(
        db.String,
        default=lambda: "".join(random.choice(random_numbers) for _ in range(8)),
        unique=True,
    )

    def __repr__(self):
        return self.name

class OrderHistory(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    user_id = db.Column(db.Integer, db.ForeignKey("user.id"), nullable=False)
    order_id = db.Column(db.String(50), nullable=False)
    items = db.Column(db.Text, nullable=False)
    order_total = db.Column(db.Float, nullable=False)
    order_date = db.Column(db.DateTime, default=datetime.utcnow)

class Category(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    name = db.Column(db.String, nullable=False, unique=True)

    @property
    def product_count(self):
        return Product.query.filter_by(category_name=self.name).count()

    def __repr__(self):
        return self.name

class Order(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    username = db.Column(db.String, nullable=False)
    email = db.Column(db.String, nullable=False)
    phonenumber = db.Column(db.String, nullable=False)
    addressline1 = db.Column(db.String, nullable=False)
    addressline2 = db.Column(db.String, nullable=True, default=None)
    city = db.Column(db.String, nullable=False)
    postal = db.Column(db.String, nullable=False)
    region = db.Column(db.String, nullable=False)
    country = db.Column(db.String, nullable=False)
    notes = db.Column(db.String, nullable=True, default=None)
    status = db.Column(db.String, nullable=False)
    items = db.Column(db.String, nullable=False)
    order_total = db.Column(db.String, nullable=False)
    order_id = db.Column(db.String, nullable=False, unique=True)
    date = db.Column(db.DateTime, nullable=False, default=datetime.utcnow())
    user_id = db.Column(db.Integer, db.ForeignKey("user.id"), nullable=False)

class Cart(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    name = db.Column(db.String, nullable=False)
    description = db.Column(db.String, nullable=False)
    price = db.Column(db.Float, nullable=False)
    category_id = db.Column(db.Integer, db.ForeignKey("category.id"), nullable=False)
    category_name = db.Column(db.String, nullable=False)
    category = db.relationship("Category", backref="cart_products")
    quantity = db.Column(db.Integer, nullable=False)
    user_id = db.Column(db.Integer, db.ForeignKey("user.id"), nullable=False)
    recognition_id = db.Column(db.String, nullable=False)

    def __repr__(self):
        return self.name

    __table_args__ = (
        db.UniqueConstraint("name", "user_id", name="unique_item_in_cart"),
    )

class Wishlist(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    name = db.Column(db.String, nullable=False)
    description = db.Column(db.String, nullable=False)
    price = db.Column(db.Float, nullable=False)
    category_id = db.Column(db.Integer, db.ForeignKey("category.id"), nullable=False)
    category_name = db.Column(db.String, nullable=False)
    category = db.relationship("Category", backref="wishlist_products")
    quantity = db.Column(db.Integer, default=0, nullable=False)
    user_id = db.Column(db.Integer, db.ForeignKey("user.id"), nullable=False)
    recognition_id = db.Column(db.String, nullable=False)

    def __repr__(self):
        return self.name

    __table_args__ = (
        db.UniqueConstraint("name", "user_id", name="unique_item_in_wishlist"),
    )

class Token(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    email = db.Column(db.String, unique=True, nullable=False)
    token = db.Column(db.String, unique=True, nullable=False)
    token_type = db.Column(db.String, nullable=False)
    token_created_date = db.Column(
        db.DateTime, default=datetime.utcnow(), nullable=False
    )
    token_expiration_date = db.Column(
        db.DateTime,
        default=lambda: datetime.utcnow() + timedelta(minutes=5),
        nullable=False,
    )

class CreateProductForm(FlaskForm):
    front_image = FileField("upload image", validators=[DataRequired()])
    back_image = FileField("upload image", validators=[DataRequired()])
    name = StringField("name", validators=[DataRequired()])
    description = StringField("description", validators=[DataRequired()])
    price = DecimalField("price", places=2, validators=[DataRequired()])
    quantity = IntegerField(
        "quantity", validators=[DataRequired(), NumberRange(min=1)], default=1
    )
    category = SelectField("category", coerce=int, validators=[DataRequired()])
    submit = SubmitField()

class CreateCategoryForm(FlaskForm):
    name = StringField("category name", validators=[DataRequired()])
    submit = SubmitField()

class AuthForm(FlaskForm):
    email = StringField("email", validators=[DataRequired()])
    password = PasswordField("password")
    submit = SubmitField("Sign In")

class AuthCheckForm(FlaskForm):
    email = StringField("email", validators=[DataRequired()])
    submit = SubmitField("Sign In")

class RequestPasswordResetForm(FlaskForm):
    email = EmailField("email", validators=[DataRequired()])
    submit = SubmitField("Send Reset Link")

class ResetPasswordForm(FlaskForm):
    new_password = StringField("new password", validators=[DataRequired()])
    confirm_new_password = StringField(
        "confirm new password", validators=[DataRequired()]
    )
    submit = SubmitField("Update Password")

class RemoveCartItemForm(FlaskForm):
    name = StringField("name", validators=[DataRequired()])
    submit = SubmitField("Delete")

class AddToCartForm(FlaskForm):
    recognition_id = StringField("recognition_id", validators=[DataRequired()])
    name = StringField("name", validators=[DataRequired()])
    price = DecimalField("price", places=2, validators=[DataRequired()])
    quantity = IntegerField("quantity", validators=[DataRequired(), NumberRange(min=1)])
    submit = SubmitField("Add to Cart")

class AddToWishListForm(FlaskForm):
    recognition_id = StringField("recognition_id", validators=[DataRequired()])
    name = StringField("name", validators=[DataRequired()])
    price = DecimalField("price", places=2, validators=[DataRequired()])
    quantity = IntegerField("quantity", validators=[DataRequired(), NumberRange(min=1)])
    submit = SubmitField("Add to Cart")

class AccountForm(FlaskForm):
    username = StringField("username")
    email = EmailField("username")
    phonenumber = StringField("phonenumber")
    current_password = StringField("current password")
    new_password = StringField("password")
    confirm_new_password = StringField("confirm password")
    submit = SubmitField("Update Information")

class UpdateCategoryForm(FlaskForm):
    current_name = StringField("")
    new_name = StringField("category name", validators=[DataRequired()])
    submit = SubmitField("Update Category Name")

class CheckoutForm(FlaskForm):
    username = StringField("Username", validators=[DataRequired()])
    email = EmailField("Email", validators=[DataRequired()])
    phonenumber = StringField("Phone", validators=[DataRequired()])
    addressline1 = StringField("Address Line 1", validators=[DataRequired()])
    addressline2 = StringField("Address Line 2")
    city = StringField("City", validators=[DataRequired()])
    postal = StringField("Postal", validators=[DataRequired()])

    region = SelectField(
        "Region",
        validators=[DataRequired()],
        choices=[
            ("", "Select Region"),
            ("Attica", "Attica"),
            ("Central Greece", "Central Greece"),
            ("Central Macedonia", "Central Macedonia"),
            ("Crete", "Crete"),
            ("Eastern Macedonia and Thrace", "Eastern Macedonia and Thrace"),
            ("Epirus", "Epirus"),
            ("Ionian Islands", "Ionian Islands"),
            ("North Aegean", "North Aegean"),
            ("Peloponnese", "Peloponnese"),
            ("South Aegean", "South Aegean"),
            ("Thessaly", "Thessaly"),
            ("Western Greece", "Western Greece"),
            ("Western Macedonia", "Western Macedonia"),
        ],
    )

    country = SelectField(
        "Country",
        validators=[DataRequired()],
        choices=[("", "Select Country"), ("GR", "Greece")],
    )

    notes = TextAreaField("Notes")

@app.route("/")
def shop():
    cart_items = []
    if current_user.is_authenticated:
        cart_items = Cart.query.filter_by(user_id=current_user.id).all()
    return render_template(
        "shop.html",
        products=Product.query.all(),
        add_to_cart_form=AddToCartForm(),
        cart_items=cart_items,
        categories=Category.query.all(),
    )

@app.route("/category/<categoryname>", methods=["GET", "POST"])
def category(categoryname):
    cart_items = []
    if current_user.is_authenticated:
        cart_items = Cart.query.filter_by(user_id=current_user.id).all()
    return render_template(
        "category.html",
        products=Product.query.filter_by(category_name=categoryname).all(),
        categories=Category.query.all(),
        cart_items=cart_items,
        add_to_cart_form=AddToCartForm(),
    )

@app.route("/auth", methods=["GET", "POST"])
def auth():
    if current_user.is_authenticated:
        return redirect("/")
    
    if AuthForm().validate_on_submit():
        email = AuthForm().email.data
        password = AuthForm().password.data
        user = User.query.filter_by(email=email).first()

        if not user:
            token = "".join(
                random.choice(random_numbers + random_string) for _ in range(50)
            )
            existing_token = Token.query.filter_by(
                email=email, token_type="EmailVerify"
            ).first()

            if existing_token:
                existing_token.token = token
                existing_token.token_created_date = datetime.utcnow()
                existing_token.token_expiration_date = datetime.utcnow() + timedelta(
                    minutes=5
                )
                existing_token.token_type = "EmailVerify"
            else:
                new_token = Token(
                    email=email,
                    token=token,
                    token_type="EmailVerify",
                    token_created_date=datetime.utcnow(),
                    token_expiration_date=datetime.utcnow() + timedelta(minutes=5),
                )
                db.session.add(new_token)

            db.session.commit()

            try:
                verify_email_url = f"http://127.0.0.1:5000/verify_email/{token}"
                body = render_template(
                    "verify_registration_email.html", verify_email_url=verify_email_url
                )
                message = Message(
                    subject="Email confirmation for your registration at MacDuck",
                    sender=app.config["MAIL_USERNAME"],
                    recipients=[email],
                    html=body,
                )
                mail.send(message)
                flash("Verification email sent. Please check your inbox.", "auth")
            except Exception as e:
                print(f"Error sending verification email: {e}")
                flash("Error sending verification email. Please try again.", "auth")

            return redirect("/auth")

        if not user.is_account_completed:
            if not password:
                flash("Please enter a password to complete your account.", "auth")
                return render_template("auth.html", auth_form=AuthForm())

            user.password = bc.generate_password_hash(password).decode("utf-8")
            user.is_account_completed = True
            db.session.commit()
            login_user(user)
            flash("Account setup completed successfully!", "success")
            return redirect("/")

        else:
            if not password:
                flash("Password is required.", "auth")
                return render_template("auth.html", auth_form=AuthForm())

            if not bc.check_password_hash(user.password, password):
                flash("Invalid password.", "auth")
                return jsonify(success=False, message="Invalid password"), 401

            login_user(user)
            return jsonify(success=True, message="Successfully logged in!"), 200

    return render_template("auth.html", auth_form=AuthForm())


@app.route("/verify_email/<token>")
def verify_email(token):

    token_obj = Token.query.filter_by(token=token, token_type="EmailVerify").first()
    if not token_obj:
        flash("Invalid or expired verification link", "danger")
        return redirect("/auth")

    newuser = User(
        username=token_obj.email.split("@")[0].replace(".", "_"),
        email=token_obj.email,
        password=None,
        phonenumber=None,
        is_admin=False,
        is_account_completed=False,
    )

    db.session.add(newuser)
    db.session.delete(token_obj)
    db.session.commit()

    flash("Email verified successfully! You can now set your password.", "success")
    return redirect("/auth")


@app.route("/auth/check", methods=["POST"])
def auth_check():
    data = request.get_json()
    email = data.get("email")

    user = User.query.filter_by(email=email).first()
    if user:
        return jsonify(
            {"Exists": True, "isAccountCompleted": user.is_account_completed}
        )
    else:
        return jsonify({"Exists": False, "isAccountCompleted": False})

@app.route("/logout")
@login_required
def logout():
    logout_user()
    return redirect("/auth")

@app.route("/cart/add", methods=["POST"])
@login_required
def add_to_cart():
    if AddToCartForm().validate_on_submit():
        product = Product.query.filter_by(
            recognition_id=AddToCartForm().recognition_id.data
        ).first()
        existing_item = Cart.query.filter_by(
            user_id=current_user.id, name=AddToCartForm().name.data
        ).first()
        if existing_item:
            existing_item.quantity += AddToCartForm().quantity.data
            db.session.commit()
        else:
            new_item = Cart(
                name=AddToCartForm().name.data,
                description=product.description,
                price=float(AddToCartForm().price.data),
                quantity=AddToCartForm().quantity.data,
                category_id=product.category_id,
                category_name=product.category_name,
                user_id=current_user.id,
                recognition_id=product.recognition_id,
            )
            db.session.add(new_item)
            db.session.commit()
        referrer = request.referrer or "/"
        return redirect(referrer)
    return redirect("/")

@app.route("/wishlist/add", methods=["POST"])
@login_required
def add_to_wishlist():
    if AddToWishListForm().validate_on_submit():
        product = Product.query.filter_by(
            recognition_id=AddToWishListForm().recognition_id.data
        ).first()
        if not product:
            flash("Product not found.", "error")
            return redirect(request.referrer or "/")
        try:
            quantity = int(AddToWishListForm().quantity.data)
        except (ValueError, TypeError):
            quantity = 1 
        existing_item = Wishlist.query.filter_by(
            user_id=current_user.id, name=AddToWishListForm().name.data
        ).first()
        if existing_item:
            existing_item.quantity += quantity
            db.session.commit()
        else:
            new_item = Wishlist(
                name=AddToWishListForm().name.data,
                description=product.description,
                price=float(AddToWishListForm().price.data),
                quantity=quantity,
                category_id=product.category_id,
                category_name=product.category_name,
                user_id=current_user.id,
                recognition_id=product.recognition_id,
            )
            db.session.add(new_item)
            db.session.commit()
        return redirect(request.referrer or "/")
    flash("Form validation failed.", "error")
    return redirect(request.referrer or "/")

@app.route("/wishlist/remove/<recognition_id>", methods=["GET", "POST"])
@login_required
def wishlist_remove(recognition_id):
    wishlist_product = Wishlist.query.filter_by(
        user_id=current_user.id, recognition_id=recognition_id
    ).first()
    if wishlist_product:
        db.session.delete(wishlist_product)
        db.session.commit()
    referrer = request.referrer or "/"
    return redirect(referrer)

@app.route("/admin", methods=["GET", "POST"])
@login_required
@admin_requiredf
def admin():
    # Set up the form instance and set choices once
    form_product = CreateProductForm()
    form_product.category.choices = [(c.id, c.name) for c in Category.query.all()]

    form_category = CreateCategoryForm()

    if form_product.validate_on_submit() and request.method == "POST":
        name = form_product.name.data
        price = form_product.price.data
        quantity = form_product.quantity.data
        front_image = form_product.front_image.data
        back_image = form_product.back_image.data
        description = form_product.description.data
        category_id = form_product.category.data
        category_obj = Category.query.get(category_id)
        category_name = category_obj.name if category_obj else None

        product_folder = os.path.join(upload_folder, name)
        if not os.path.exists(product_folder):
            os.makedirs(product_folder)

        front_image_name = secure_filename(front_image.filename)
        back_image_name = secure_filename(back_image.filename)

        front_image_path = os.path.join(product_folder, front_image_name)
        back_image_path = os.path.join(product_folder, back_image_name)

        front_image.save(front_image_path)
        back_image.save(back_image_path)

        product = Product(
            name=name,
            price=price,
            quantity=quantity,
            front_image=front_image_path,
            back_image=back_image_path,
            description=description,
            category_id=category_id,
            category_name=category_name,
        )

        db.session.add(product)
        db.session.commit()
        return redirect("/admin")

    elif form_category.validate_on_submit() and request.method == "POST":
        name = form_category.name.data.strip()
        existing_category = Category.query.filter_by(name=name).first()
        if existing_category:
            flash(f"Category '{name}' already exists.")
        else:
            category = Category(name=name)
            db.session.add(category)
            db.session.commit()
            return redirect("/admin")

    total_users = User.query.all()
    total_products = Product.query.all()
    categories = Category.query.all()
    total_orders = Order.query.all()
    total_revenue = sum(item.order_total for item in OrderHistory.query.all())
    recent_orders = Order.query.filter_by(status="Paid").order_by(Order.id.desc()).all()

    return render_template(
        "admin.html",
        update_category_form=UpdateCategoryForm(),
        create_category_form=form_category,
        recent_orders=recent_orders,
        total_users=total_users,
        total_products=total_products,
        total_orders=total_orders,
        total_revenue=total_revenue,
        categories=categories,
        create_product_form=form_product,
    )

@app.route("/admin/update/category", methods=["GET", "POST"])
@admin_required
def update_category():
    if request.method == "POST" and UpdateCategoryForm().validate_on_submit():
        current_category_name = UpdateCategoryForm().current_name.data
        new_category_name = UpdateCategoryForm().new_name.data
        category = Category.query.filter_by(name=current_category_name).first()
        category_products = Product.query.filter_by(
            category_name=current_category_name
        ).all()

        if category_products:
            for product in category_products:
                product.category_name = new_category_name

        if category:
            category.name = new_category_name
            db.session.commit()
            return redirect("/admin")

@app.route("/admin/delete/category/<int:category_id>")
@admin_required
def delete_category(category_id):
    category = Category.query.get(category_id)
    if category:
        try:
            db.session.delete(category)
            db.session.commit()
            return redirect("/admin")
        except Exception as e:
            db.session.rollback()
            return f"An error occurred while deleting the category: {e}", 500
    else:
        return "Category not found.", 404

@app.route("/admin/delete/product/<rid>")
@admin_required
def delete_product(rid):
    product = Product.query.filter_by(recognition_id=rid).first()
    if product:
        try:
            product_in_cart = Cart.query.filter_by(recognition_id=rid).first()
            if product_in_cart:
                db.session.delete(product_in_cart)
            product_in_wishlist = Wishlist.query.filter_by(recognition_id=rid).first()
            if product_in_wishlist:
                db.session.delete(product_in_wishlist)
            db.session.delete(product)
            db.session.commit()
            return redirect(request.referrer)
        except Exception as e:
            db.session.rollback()
            return f"An error occurred while deleting the product: {e}", 500
    else:
        return "Product not found.", 404

@app.route("/sif/<recognition_id>")
def sif(recognition_id):
    product = Product.query.filter_by(recognition_id=recognition_id).first()
    if product:
        image_path = os.path.join("static", product.front_image)
        return send_from_directory(
            os.path.dirname(image_path), os.path.basename(image_path)
        )
    return "Image not found", 404

@app.route("/sib/<recognition_id>")
def sib(recognition_id):
    product = Product.query.filter_by(recognition_id=recognition_id).first()
    if product:
        image_path = os.path.join("static", product.back_image)
        return send_from_directory(
            os.path.dirname(image_path), os.path.basename(image_path)
        )
    return "Image not found", 404

@app.route("/cart", methods=["GET", "POST"])
@login_required
def cart():
    cart_items = Cart.query.filter_by(user_id=current_user.id).all()
    categories = Category.query.all()
    return render_template(
        "cart.html",
        cart_items=cart_items,
        remove_item_form=RemoveCartItemForm(),
        STRIPE_PUBLISHABLE_KEY=STRIPE_PUBLISHABLE_KEY,
        categories=categories,
    )

@app.route("/cart/item/remove", methods=["GET", "POST"])
@login_required
def remove_cart_item():
    if request.method == "POST" and RemoveCartItemForm().validate_on_submit():
            product = Cart.query.filter_by(
                user_id=current_user.id, name=RemoveCartItemForm().name.data
            ).first()
            if product:
                db.session.delete(product)
                db.session.commit()
                return redirect("/cart")
            return "Product not found", 404

@app.route("/cart/checkout", methods=["GET", "POST"])
@login_required
def cart_checkout():
    cart_items = Cart.query.filter_by(user_id=current_user.id).all()
    if not Cart.query.filter_by(user_id=current_user.id).all():
        return redirect("/cart")
    
    order_total = sum(item.price * item.quantity for item in cart_items)

    if request.method == "POST" and CheckoutForm().validate_on_submit():
        username = CheckoutForm().username.data
        email = CheckoutForm().email.data
        phonenumber = CheckoutForm().phonenumber.data
        addressline1 = CheckoutForm().addressline1.data
        addressline2 = CheckoutForm().addressline2.data
        postal = CheckoutForm().postal.data
        city = CheckoutForm().city.data
        region = CheckoutForm().region.data
        country = CheckoutForm().country.data
        notes = CheckoutForm().notes.data
        items = ",".join([item.name for item in cart_items])

        order_id_string = ""
        for _ in range(10):
            order_id_string += random.choice(random_string)
        order_id = "#ORD-" + order_id_string.upper()
        neworder = Order(
            username=username,
            email=email,
            phonenumber=phonenumber,
            addressline1=addressline1,
            addressline2=addressline2,
            city=city,
            postal=postal,
            region=region,
            country=country,
            notes=notes,
            order_id=order_id,
            date=datetime.utcnow(),
            user_id=current_user.id,
            status="Pending",
            items=items,
            order_total=order_total,
        )

        db.session.add(neworder)
        db.session.commit()
        return redirect(url_for("create_checkout_session"))

    return render_template(
        "checkout.html", cart_items=cart_items, order_total=order_total, checkout_form=CheckoutForm()
    )

@app.route("/search")
def search():
    query = request.args.get("q", "")
    if query:
        products = Product.query.filter(
            or_(
                Product.name.ilike(f"%{query}%"),
                Product.description.ilike(f"%{query}%"),
            )
        ).all()
    else:
        products = Product.query.all()

    products_list = []
    for product in products:
        products_list.append(
            {
                "id": product.id,
                "recognition_id": product.recognition_id,
                "name": product.name,
                "description": product.description,
                "price": product.price,
                "quantity": product.quantity,
            }
        )

    return jsonify(products_list)


@app.route("/increase_quantity", methods=["GET", "POST"])
@login_required
def increase_quantity():
    id = request.form.get("item_id")
    product = Cart.query.filter_by(user_id=current_user.id, id=id).first()
    product.quantity += 1
    db.session.commit()
    return redirect("/cart")


@app.route("/decrease_quantity", methods=["GET", "POST"])
@login_required
def decrease_quantity():
    id = request.form.get("item_id")
    product = Cart.query.filter_by(user_id=current_user.id, id=id).first()
    if product.quantity > 1:
        product.quantity -= 1
        db.session.commit()
        return redirect("/cart")
    else:
        db.session.delete(product)
        db.session.commit()
        return redirect("/cart")


@app.route("/forgot-password", methods=["GET", "POST"])
def reset_password_request():
    if request.method == "POST" and RequestPasswordResetForm().validate_on_submit():
        email = RequestPasswordResetForm().email.data
        user = User.query.filter_by(email=email).first()
        if user:
            token = "".join(
                [
                    random.choice(random_numbers + random_string + random_symbols)
                    for _ in range(150)
                ]
            )
            existing_token = Token.query.filter_by(
                email=email, token_type="EmailVerify"
            ).first()

            if existing_token:
                existing_token.token = token
                existing_token.token_created_date = datetime.utcnow()
                existing_token.token_expiration_date = datetime.utcnow() + timedelta(
                    minutes=5
                )
                existing_token.token_type = "PasswordReset"
            else:
                new_token = Token(
                    email=email,
                    token=token,
                    token_type="PasswordReset",
                    token_created_date=datetime.utcnow(),
                    token_expiration_date=datetime.utcnow() + timedelta(minutes=5),
                )
                db.session.add(new_token)
            db.session.commit()

            email_html = render_template(
                "reset_password_email.html",
                username=user.username,
                reset_password_url=f"http://127.0.0.1:5000/users/reset_pass/{token}",
            )
            msg = Message(
                subject="Password Reset Request",
                sender=os.getenv("MAIL_USERNAME"),
                recipients=[email],
                html=email_html,
            )
            mail.send(msg)
            flash("We have sent you the reset link", "success")
            return redirect("/forgot-password")
    else:
        flash("No account found with that username", "danger")

    return render_template("forgotpassword.html", request_password_reset_form=RequestPasswordResetForm())


@app.route("/users/reset_pass/<token>", methods=["GET", "POST"])
def resetpassword(token):

    token_obj = Token.query.filter_by(token=token, token_type="PasswordReset").first()
    if not token_obj:
        flash("Invalid or expired reset link", "danger")
        return redirect("/forgot-password")

    user = User.query.filter_by(email=token_obj.email).first()
    if not user:
        flash("User not found", "danger")
        return redirect("/forgot-password")

    if ResetPasswordForm().validate_on_submit():
        new_password = ResetPasswordForm().new_password.data
        confirm_new_password = ResetPasswordForm().confirm_new_password.data

        if new_password == confirm_new_password:
            hashed_password = bc.generate_password_hash(new_password).decode("utf-8")
            user.password = hashed_password
            db.session.delete(token_obj)
            db.session.commit()
            flash("Password reset successfully", "success")
            return redirect("/auth")
        else:
            flash("Password confirmation does not match", "danger")
            return redirect(f"/users/reset_pass/{token}")

    return render_template("reset_password.html", token=token, reset_password_form=ResetPasswordForm())


@app.route("/account", methods=["GET", "POST"])
@login_required
def account():
    if request.method == "POST" and AccountForm().validate_on_submit():
        username = AccountForm().username.data
        email = AccountForm().email.data
        phonenumber = AccountForm().phonenumber.data
        current_password = AccountForm().current_password.data
        new_password = AccountForm().new_password.data
        confirm_new_password = AccountForm().confirm_new_password.data

        if username != current_user.username:
            if User.query.filter_by(username=username).first():
                flash("username is taken")
                return redirect("/account")
            else:
                current_user.username = username

        if email != current_user.email:
            if User.query.filter_by(email=email).first():
                flash("email is taken")
                return redirect("/account")
            else:
                current_user.email = email

        if phonenumber != current_user.phonenumber:
            if User.query.filter_by(phonenumber=phonenumber).first():
                flash("phonenumber is taken")
                return redirect("/account")
            else:
                current_user.phonenumber = phonenumber

        if current_password:
            if bc.check_password_hash(current_user.password, current_password):
                if new_password and confirm_new_password == new_password:
                    hashed_password = bc.generate_password_hash(new_password).decode(
                        "utf-8"
                    )
                    current_user.password = hashed_password
                else:
                    flash("The confirmed password does not match.")
                    return redirect("/account")
            else:
                flash("Wrong current password.")
                return redirect("/account")

        flash("Account updated successfully!", "success")
        db.session.commit()
        return redirect("/account")

    order_history = OrderHistory.query.filter_by(user_id=current_user.id).all()
    cart_items = Cart.query.filter_by(user_id=current_user.id).all()
    return render_template(
        "account.html", account_form=AccountForm(), order_history=order_history, cart_items=cart_items
    )


@app.route("/product/<recognition_id>/<name>", methods=["GET", "POST"])
@login_required
def product_page(recognition_id, name):
    product = Product.query.filter_by(recognition_id=recognition_id).first()

    if not product:
        flash("Product not found", "danger")
        return redirect("/")

    cart_items = Cart.query.filter_by(user_id=current_user.id).all()
    categories = Category.query.all()

    cart_item = Cart.query.filter_by(
        user_id=current_user.id, recognition_id=product.recognition_id
    ).first()

    in_wishlist = Wishlist.query.filter_by(
        user_id=current_user.id, recognition_id=product.recognition_id
    ).first()

    return render_template(
        "product.html",
        product=product,
        add_to_cart_form=AddToCartForm(),
        add_to_wishlist_form=AddToWishListForm(),
        cart_items=cart_items,
        cart_item=cart_item,
        categories=categories,
        in_wishlist=in_wishlist,
    )

@app.route("/create-checkout-session", methods=["POST", "GET"])
@login_required
def create_checkout_session():
    try:
        cart_items = Cart.query.filter_by(user_id=current_user.id).all()
        line_items = []

        for item in cart_items:
            image_url = url_for(
                "sif", recognition_id=item.recognition_id, _external=True
            )

            line_items.append(
                {
                    "price_data": {
                        "currency": "eur",
                        "product_data": {
                            "name": item.name,
                        },
                        "unit_amount": int(float(item.price) * 100),
                    },
                    "quantity": item.quantity,
                }
            )

        line_items.append(
            {
                "price_data": {
                    "currency": "eur",
                    "product_data": {
                        "name": "Shipping Fee",
                    },
                    "unit_amount": 500,
                },
                "quantity": 1,
            }
        )

        checkout_session = stripe.checkout.Session.create(
            line_items=line_items,
            mode="payment",
            payment_method_types=["card"],
            customer_email=current_user.email,
            success_url=url_for("shop", _external=True)
            + "?session_id={CHECKOUT_SESSION_ID}",
            cancel_url=url_for("cancel_checkout", _external=True),
        )
        return redirect(checkout_session.url, code=303)
    except Exception as e:
        print(e)
        return "Server error", 500


@app.route("/checkout/cancelled")
@login_required
def cancel_checkout():
    user = User.query.filter_by(email=current_user.email).first()
    if user:
        orders = Order.query.filter_by(user_id=user.id, status="Pending").all()
        for order in orders:
            db.session.delete(order)
        db.session.commit()
    return redirect("/cart/checkout")


@app.route("/create-portal-session", methods=["POST"])
@login_required
def customer_portal():
    checkout_session_id = request.form.get("session_id")
    checkout_session = stripe.checkout.Session.retrieve(checkout_session_id)

    return_url = url_for("account")

    portalSession = stripe.billing_portal.Session.create(
        customer=checkout_session.customer,
        return_url=return_url,
    )
    return redirect(portalSession.url, code=303)


@app.route("/webhook", methods=["POST"])
def webhook_received():
    webhook_secret = os.getenv("STRIPE_WEBHOOK_SECRET")
    request_data = json.loads(request.data)

    if webhook_secret:

        signature = request.headers.get("stripe-signature")
        try:
            event = stripe.Webhook.construct_event(
                payload=request.data, sig_header=signature, secret=webhook_secret
            )
            data = event["data"]
        except Exception as e:
            return e

        event_type = event["type"]
    else:
        data = request_data["data"]
        event_type = request_data["type"]
    data_object = data["object"]

    print("event " + event_type)

    if event_type == "checkout.session.completed":
        print("🔔 Payment succeeded!")
        session = event["data"]["object"]
        user_email = session.get("customer_email")
        user = User.query.filter_by(email=user_email).first()

        pending_order = Order.query.filter_by(user_id=user.id, status="Pending").first()

        if pending_order:
            pending_order.status = "Paid"

        cart_items = Cart.query.filter_by(user_id=user.id).all()
        item_names = [item.name for item in cart_items]
        items_str = ", ".join(item_names)
        order_total = sum(item.price * item.quantity for item in cart_items)

        for item in cart_items:
            product = Product.query.filter_by(
                recognition_id=item.recognition_id
            ).first()
            if product:
                product.quantity = max(0, product.quantity - item.quantity)

        if user:
            new_order_history = OrderHistory(
                user_id=user.id,
                order_id=pending_order.order_id,
                items=items_str,
                order_total=order_total,
                order_date=datetime.utcnow(),
            )

            db.session.add(new_order_history)

            try:
                body = render_template("payment_success.html", username=user.username)
                msg = Message(
                    subject="Payment Success",
                    sender=app.config["MAIL_USERNAME"],
                    recipients=[user_email],
                    html=body,
                )
                mail.send(msg)
            except Exception as e:
                print(f"Failed to send email: {e}")

            for item in cart_items:
                db.session.delete(item)

            order = Order.query.filter_by(user_id=user.id).first()
            order.status = "Paid"
            db.session.commit()

        return jsonify({"status": "success"})

    elif event_type == "checkout.session.expired":
        print("❌ Checkout session expired!")
        session = event["data"]["object"]
        user_email = session.get("customer_email")
        user = User.query.filter_by(email=user_email).first()
        if user:
            orders = Order.query.filter_by(user_id=user.id, status="Pending").all()
            for order in orders:
                db.session.delete(order)
            db.session.commit()
        return jsonify({"status": "failed"})

if __name__ == "__main__":
    with app.app_context():
        db.create_all()

        # TEST ADMIN USER
        if not User.query.filter_by(username="lorentzos").first():
            hp = bc.generate_password_hash("Lorentzos1234").decode("utf-8")
            newuser = User(
                username="lorentzos",
                password=hp,
                phonenumber="",
                email="georgelorentzos08@gmail.com",
                is_admin=True,
                is_account_completed=True,
            )
            db.session.add(newuser)
            db.session.commit()

    app.run(debug=True, host="0.0.0.0", port=5000)</code></pre>
         <div class="footer">
            <span>© 2025 Lorentzos.</span>
         </div>
         <br>
      </div>
      <script>
         document.addEventListener('DOMContentLoaded', function () {
         const keywords = ['def', 'return', 'if', 'else', 'elif', 'for', 'while', 'in', 'and', 'or', 'not', 'class', 'from', 'import', 'as', 'with', 'try', 'except', 'finally', 'raise'];
         const builtins = ['print', 'len', 'int', 'str', 'list', 'dict', 'set', 'bool', 'range', 'type', 'None', 'True', 'False'];
         document.querySelectorAll('pre > code').forEach(codeBlock => {
           if (codeBlock.classList.contains('language-python') || codeBlock.textContent.match(/\b(def|return|from|import)\b/)) {
             codeBlock.classList.add('language-python');
             const text = codeBlock.textContent;
             const tokens = [];
             let current = '';
             let i = 0;
             while (i < text.length) {
               if (text[i].match(/[a-zA-Z_]/) && (i === 0 || !text[i-1].match(/[a-zA-Z0-9_]/))) {
                 let word = '';
                 while (i < text.length && text[i].match(/[a-zA-Z0-9_]/)) {
                   word += text[i];
                   i++;
                 }
                 if (keywords.includes(word)) {
                   tokens.push(`<span class="token-keyword">${word}</span>`);
                 } else if (builtins.includes(word)) {
                   tokens.push(`<span class="token-builtin">${word}</span>`);
                 } else if (word && tokens[tokens.length-1] === '<span class="token-keyword">def</span> ') {
                   tokens.push(`<span class="token-function">${word}</span>`);
                 } else {
                   tokens.push(word);
                 }
                 continue;
               }
               if (text[i] === "'" || text[i] === '"') {
                 let str = text[i];
                 i++;
                 while (i < text.length && text[i] !== str[0]) {
                   str += text[i];
                   i++;
                 }
                 if (i < text.length) str += text[i];
                 i++;
                 tokens.push(`<span class="token-string">${str}</span>`);
                 continue;
               }
               if (text[i].match(/\d/) && (i === 0 || !text[i-1].match(/[a-zA-Z0-9_]/))) {
                 let num = '';
                 while (i < text.length && text[i].match(/\d/)) {
                   num += text[i];
                   i++;
                 }
                 tokens.push(`<span class="token-number">${num}</span>`);
                 continue;
               }
               if (text[i].match(/[.,:;()\[\]{}]/)) {
                 tokens.push(`<span class="token-punctuation">${text[i]}</span>`);
                 i++;
                 continue;
               }
               tokens.push(text[i]);
               i++;
             }
             codeBlock.innerHTML = tokens.join('');
           }
         });
         const style = document.createElement('style');
         style.textContent = `
           pre > code.language-python {
             background: var(--codebox);
             color: #abb2bf;
             font-family: 'Fira Code', 'Consolas', monospace;
           }
           pre > code.language-python .token-keyword {
             color: #c678dd;
           }
           pre > code.language-python .token-function {
             color: #e6c07b;
           }
           pre > code.language-python .token-string {
             color: #98c379;
           }
           pre > code.language-python .token-number {
             color: #d19a66;
           }
           pre > code.language-python .token-builtin {
             color: #56b6c2;
           }
           pre > code.language-python .token-punctuation {
             color: #abb2bf;
           }
         `;
         document.head.appendChild(style);
         });
      </script>
      <script>
         document.getElementById('year').textContent = new Date().getFullYear();
      </script>
   </body>
</html>